package test_1;

import org.junit.Assert;
import org.junit.Test;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;

import java.util.concurrent.TimeUnit;

public class MainPageOpenTest {
    private String HOME_PAGE = "http://cinamonkino.lv";
    private String TEST_EMAIL = "neotech-test-2@mailinator.com";
    private String TEST_PASSWORD = "password1";


    @Test //should be executed only once to create new customer
    public void registrationTest() {
        WebDriver driver = new ChromeDriver();
        driver.manage().window().maximize();
        //opening homepage
        driver.get(HOME_PAGE);
        driver.manage().timeouts().implicitlyWait(3, TimeUnit.SECONDS);
        driver.findElement(By.xpath("//*[@id=\"promo-text\"]/a[1]")).click();
        driver.findElement(By.className("new-account")).click();
        driver.findElement(By.id("firstname")).sendKeys("Neo");
        driver.findElement(By.id("lastname")).sendKeys("Tech");
        driver.findElement(By.name("dob[day]")).sendKeys("12");
        driver.findElement(By.name("dob[month]")).sendKeys("janvƒÅris");
        driver.findElement(By.name("dob[year]")).sendKeys("1987");
        driver.findElement(By.id("gender_male")).click();
        driver.findElement(By.name("telephone")).sendKeys("+371 6690 1753");
        driver.findElement(By.name("email")).sendKeys(TEST_EMAIL);
        driver.findElement(By.name("password")).sendKeys(TEST_PASSWORD);
        driver.findElement(By.name("repassword")).sendKeys(TEST_PASSWORD);
        driver.findElement(By.name("reg-conditions-agree")).click();
        driver.findElement(By.className("big-button")).click();
        driver.close();


    }

    @Test
    public void mainTest() {
        WebDriver driver = new ChromeDriver();
        driver.manage().window().maximize();
        driver.get(HOME_PAGE);
        driver.manage().timeouts().implicitlyWait(3, TimeUnit.SECONDS);
        driver.findElement(By.xpath("//*[@id=\"promo-text\"]/a[1]")).click();
        driver.findElement(By.className("username")).click();
        driver.findElement(By.name("username")).click();
        driver.findElement(By.name("username")).sendKeys(TEST_EMAIL);
        driver.findElement(By.name("password")).sendKeys(TEST_PASSWORD);
        driver.findElement(By.className("big-button")).click();
        driver.manage().timeouts().implicitlyWait(10, TimeUnit.SECONDS);

//since Cinamonkino doesn't have an option of choosing date (at least I haven't found it)
// I've chosen an option of selecting +3 days form today
        driver.findElement(By.xpath("//*[@id=\"frontpage-tabs\"]/li[5]/a")).click();
        //Yes, I know that next xpath is very messy. But that is the only solution I came up with.
        //Plus it saves a lot of code if different approach is used.
        driver.findElement(By.xpath("/html/body/div[2]/div[1]/div/div/article/ul[2]/li[5]/section/ul/li[1]/div/div[2]/div[3]/div/div/div[1]/a/div[1]/time")).click();
        driver.findElement(By.xpath("/html/body/div[2]/div[1]/div/div/article/div[4]/form/table/tbody/tr[1]/td[3]/input[4]")).click();
        driver.findElement(By.xpath("/html/body/div[2]/div[1]/div/div/article/div[4]/form/table/tbody/tr[1]/td[3]/input[4]")).click();
        String totalSum1 = driver.findElement(By.className("total")).getText();
        System.out.println("Total sum after adding two tickets = " + totalSum1);

// Coupon text input and submisstion

        driver.findElement(By.xpath("//*[@id=\"next-step\"]")).submit();

// Seat selection steps

        String rowNumber = driver.findElement(By.className("row-nr")).getText();
        String seatNumber = driver.findElement(By.className("seat-nrs")).getText();


        System.out.println("Row - " + rowNumber + " Seats - " + seatNumber);

        driver.findElement(By.xpath("//*[@id=\"seats_picked_form\"]/input")).submit();

        Assert.assertEquals(driver.findElement(By.className("total")).getText(), totalSum1);

// Cinamonkino shows different order of seats on selection and checkout.
// 2,1 on selection and 1,2 on checkout
// Need to think of a workaround. This part is unstable
//        Assert.assertTrue(driver.findElement(By.xpath("//*/div[1]/div/div[2]/div/header/table/tbody/tr[5]/td")).getText().contains(rowNumber));
//        String seatsAcsending = new StringBuffer(seatNumber).reverse().toString();
//        Assert.assertTrue(driver.findElement(By.xpath("//*/div[1]/div/div[2]/div/header/table/tbody/tr[5]/td")).getText().contains(seatsAcsending));

        driver.findElement(By.xpath("//*/div[1]/div/div[2]/div/header/table/tfoot/tr/td[1]/a")).click();


        driver.findElement(By.xpath("/html/body/div[2]/div[1]/div/div/article/div[4]/form/table/tbody/tr[1]/td[3]/input[4]")).click();
        String totalSum2 = driver.findElement(By.className("total")).getText();
        System.out.println("Total sum after removing 1 ticket = " + totalSum2);

        //coupon entry step

        driver.findElement(By.xpath("//*[@id=\"next-step\"]")).submit();
        driver.findElement(By.xpath("//*[@id=\"seats_picked_form\"]/input")).submit();
        Assert.assertEquals(driver.findElement(By.className("total")).getText(), totalSum2);
//payment methods count should be here

        driver.findElement(By.className("logout")).click();
        driver.close();
    }
}
